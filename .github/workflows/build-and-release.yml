name: Build and Release Chrome Extension

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Create extension package
      run: |
        # åˆ›å»ºä¸´æ—¶ç›®å½•ç”¨äºæ‰“åŒ…
        mkdir -p build
        
        # å¤åˆ¶æ‰€æœ‰å¿…è¦æ–‡ä»¶åˆ°buildç›®å½•
        cp manifest.json build/
        cp background.js build/
        cp popup.html build/
        cp popup.js build/
        cp content.js build/
        cp options.html build/
        cp options.js build/
        cp -r icons build/
        
        # åˆ›å»ºzipåŒ…
        cd build
        zip -r ../anypush-extension.zip .
        cd ..
        
        # æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
        ls -la anypush-extension.zip
        
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: chrome-extension-${{ github.sha }}
        path: anypush-extension.zip
        retention-days: 30
        
    - name: Create Release (on tag push)
      if: startsWith(github.ref, 'refs/tags/v')
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref_name }}
        release_name: AnyPush ${{ github.ref_name }}
        body: |
          ## AnyPush Chrome Extension ${{ github.ref_name }}
          
          ### ğŸ“¦ å®‰è£…æ–¹æ³•
          1. ä¸‹è½½ä¸‹æ–¹çš„ `anypush-extension.zip` æ–‡ä»¶
          2. è§£å‹åˆ°æœ¬åœ°æ–‡ä»¶å¤¹
          3. æ‰“å¼€Chromeæµè§ˆå™¨ï¼Œè¿›å…¥ `chrome://extensions/`
          4. å¼€å¯"å¼€å‘è€…æ¨¡å¼"
          5. ç‚¹å‡»"åŠ è½½å·²è§£å‹çš„æ‰©å±•ç¨‹åº"ï¼Œé€‰æ‹©è§£å‹åçš„æ–‡ä»¶å¤¹
          
          ### âš™ï¸ é…ç½®è¯´æ˜
          - æ’ä»¶å®‰è£…åéœ€è¦é…ç½®æ¨é€æœåŠ¡æ‰èƒ½ä½¿ç”¨
          - æ”¯æŒä¼ä¸šå¾®ä¿¡æœºå™¨äººå’ŒBarkæ¨é€æœåŠ¡
          - è¯¦ç»†é…ç½®æ–¹æ³•è¯·æŸ¥çœ‹ [INSTALL.md](https://github.com/H5Z2P5Z2P/anypush/blob/main/INSTALL.md)
          
          ### ğŸ†• ä¸»è¦åŠŸèƒ½
          - é€‰ä¸­æ–‡æœ¬æ¨é€ï¼ˆå³é”®èœå•æˆ–æ’ä»¶å›¾æ ‡ï¼‰
          - é¡µé¢é“¾æ¥æ¨é€ï¼ˆæ’ä»¶å›¾æ ‡ï¼‰
          - è‡ªå®šä¹‰æ¨é€å†…å®¹æ¨¡æ¿
          - ä¸°å¯Œçš„Barkæ¨é€é€‰é¡¹é…ç½®
          - é…ç½®äº‘åŒæ­¥åŠŸèƒ½
          
          ### ğŸ”’ éšç§ä¿æŠ¤
          - ä¸æ”¶é›†ä»»ä½•ç”¨æˆ·æ•°æ®
          - æ¨é€å†…å®¹ç›´æ¥å‘é€åˆ°ç”¨æˆ·é…ç½®çš„æœåŠ¡
          - æ‰€æœ‰é…ç½®å­˜å‚¨åœ¨æœ¬åœ°
        draft: false
        prerelease: false
        
    - name: Upload Release Asset (on tag push)
      if: startsWith(github.ref, 'refs/tags/v')
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./anypush-extension.zip
        asset_name: anypush-extension.zip
        asset_content_type: application/zip